<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>image-upscale-comparison</title>
	<style type="text/css" media="screen">
		body {
			margin: 1em;
			background: #333;
			color: #fff;
			text-shadow: 0 1px 3px #000;
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			line-height: 1;
		}
		#canvasWrapper {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}
		#canvasWrapper canvas {
			width: 100%;
			height: 100%;
			vertical-align: middle;
		}

		#imageAWrapper,
		#imageBWrapper {
			color: #fff;
			display: inline-block;
		}

		#panel {
			position: absolute;
			top: 0;
			left: 0;
			z-index: 1;
		}
	</style>
</head>
<body>
	<div id="panel">
		<div id="imageAWrapper"></div>
		<div id="imageBWrapper"></div>
		<div class="kek">Масштаб: <div id="currentZoom">100</div></div>
		<!-- <button id="butteraugliBtn">butteraugli</button>
		<button id="psnrhvsmBtn">psnrhvsm</button>
		<button id="color_psnrhmaBtn">color_psnrhvsm</button>
		<div id="currentDiff"></div> -->
		<button id="dot" disabled>Точечный</button>
		<button id="inline" disabled>Строчный</button>
		<div>
			Процент отличий:
			<span id="diffPercent"></span>
		</div>
		<div id="sizeIsDifferent" hidden>
			<div>
				Оригинал:
				<span id="referenceSize"></span>
			</div>
			<div>
				Результат:
				<span id="resultSize"></span>
			</div>
		</div>
	</div>

	<div id="canvasWrapper"></div>

<script src="paste.js"></script>
<script src="image-input.js"></script>
<script src="comparator.js"></script>
<script>
var comparator = new Comparator({
	width: 1000,
	height: 700
});
var a;
var b;

comparator.canvas.addEventListener('zoom', function (e) {
	currentZoom.innerHTML = Math.round(e.detail);
});

window.addEventListener('resize', function () {
	comparator.resize();
	comparator.reset('fit');

});

canvasWrapper.appendChild(comparator.canvas);
comparator.resize();


dot.onclick = function () {
	// сравнить картинки
	// показать отличия
	// comparator.setMap(diff.dot);
	// inline.disabled = false;
	// this.disabled = true;
}


var imageA = new ImageInput(imageAWrapper, {
	info: `
		Добавьте картинку двойным<br>
		кликом или из буфера
	`,
	onFiles: function (files) {
		comparator.setMap(null);

		var file = files[0];

		getImageData(file, function (data) {
			comparator.setA(data);
			a = data;

			getDiffImg({
				images: {
					a: a,
					b: b,
				}
			})
				.then(checkDiff)
				.then(prepareDiff)
				.then(onDiff);
		});
	}
});

var imageB = new ImageInput(imageBWrapper, {
	info: `
		Добавьте картинку двойным<br>
		кликом или из буфера
	`,
	onFiles: function (files) {
		comparator.setMap(null);

		var file = files[0];

		getImageData(file, function (data) {
			comparator.setB(data);
			b = data;

			getDiffImg({
				images: {
					a: a,
					b: b,
				}
			})
				.then(checkDiff)
				.then(prepareDiff)
				.then(onDiff);
		});
	}
});


function openFile (src) {
	Promise.all([
		getImage(src),
		getImage(src)
	])
	.then(function (data) {
		a = data[0].getContext("2d").getImageData(0,0,data[0].width,data[0].height);
		b = data[1].getContext("2d").getImageData(0,0,data[1].width,data[1].height);

		getDiffImg({
			images: {
				a: a,
				b: b,
			}
		})
			.then(checkDiff)
			.then(prepareDiff)
			.then(onDiff);

		comparator
			.setA(data[0])
			.then(function () {
				comparator.setB(data[1]);
			}).then(function () {
				comparator.reset('fit');
			})
	});
}

function getImageData (file, cb) {
	var fileUrl = URL.createObjectURL(file);
	var i = document.createElement('img');

	i.onload = function () {
		var c = document.createElement('canvas');
		var cx = c.getContext('2d');

		c.width = i.naturalWidth;
		c.height = i.naturalHeight;

		cx.drawImage(i, 0, 0);

		var data = cx.getImageData(0, 0, c.width, c.height);

		URL.revokeObjectURL(fileUrl);

		cb(data);
	};

	i.src = fileUrl;
};


function getImage (src) {
	var i = new Image();
	var c = document.createElement('canvas');
	var cx = c.getContext('2d');

	return new Promise(function (resolve, reject) {
		i.onload = function () {
			c.width = i.naturalWidth;
			c.height = i.naturalHeight;

			cx.drawImage(i, 0, 0);

			resolve(c);
		};

		i.src = src;
	});
};


function checkDiff (diff) {
	if (!diff.isDifferent) {
		return false;
	}

	return diff;
}

function prepareDiff(diff) {
	if (!diff) {
		return false;
	}

	return {
		isDifferent: diff.isDifferent,
		percent: Math.round(diff.percent * 10000) / 100 +'%',
		dot: new ImageData(new Uint8ClampedArray(diff.png.data), diff.png.width, diff.png.height),
		inline: prepareDiffInline(diff),
	}
}

function prepareDiffInline (diff) {
	var inlineData = new ImageData(new Uint8ClampedArray(diff.pngInline.data), diff.pngInline.width, diff.pngInline.height);
	var c = document.createElement('canvas');
	var cx = c.getContext('2d');

	c.width = diff.png.width + diff.pngInline.offset[0];
	c.height = diff.png.height + diff.pngInline.offset[1];

	cx.fillStyle = '#222';
	cx.fillRect(0, 0, c.width, c.height);

	cx.putImageData(inlineData, diff.pngInline.offset[0], diff.pngInline.offset[1]);

	return cx.getImageData(0, 0, c.width, c.height);
}

function onDiff (diff) {
	console.log(diff);
	if (!diff) {
		return false;
	}
	
	diffPercent.innerHTML = diff.percent;

	dot.disabled = false;
	inline.disabled = false;

	dot.onclick = function () {
		comparator.setMap(diff.dot);
		inline.disabled = false;
		this.disabled = true;
	}
	inline.onclick = function () {
		comparator.setMap(diff.inline);
		dot.disabled = false;
		this.disabled = true;
	}
}

function getDiffImg (cfg) {
	return new Promise(function (resolve, reject) {
		var worker = new Worker('getDiffImgData.worker.js?'+ Math.random());

		worker.postMessage(cfg);

		worker.onmessage = function (e) {
			resolve(e.data);
			worker.terminate();
		};
	})
}
</script>
</body>
</html>
