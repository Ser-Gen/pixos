var Vb=Object.defineProperty;var el=(l,n)=>{for(var b in n)Vb(l,b,{get:n[b],enumerable:!0,configurable:!0,set:(r)=>n[b]=()=>r})};var jn={};el(jn,{Vint:()=>{{return K}}});class K{bytes;constructor(l){this.bytes=new Uint8Array(l)}get size(){return this.bytes.length}static fromBytes(l){if(l instanceof ArrayBuffer)l=new Uint8Array(l);if(l.length===0)throw new Error("Vint cannot be empty");let n=K.leadingZeros(l[0]);if(n===8)throw new Error("Vint cannot be all zeros");if(l.length<1+n)throw new Error("Vint is too short");return new K(l.slice(0,1+n))}static async fromBlob(l){const n=await l.slice(0,8).arrayBuffer();return K.fromBytes(new Uint8Array(n))}getBytes(){return this.bytes}toBigInt(){let l=K.leadingZeros(this.bytes[0]),n=BigInt(this.bytes[0]&127>>l);for(let b=1;b<this.bytes.length;b++)n=n<<8n|BigInt(this.bytes[b]);return n}get bigint(){return this.toBigInt()}toNumber(){let l=K.leadingZeros(this.bytes[0]),n=this.bytes[0]&127>>l;for(let b=1;b<this.bytes.length;b++)n=n<<8|this.bytes[b];return n}get number(){return this.toNumber()}get id(){let l=0;for(let n of this.bytes)l=l<<8|n;return l}toString(){return`0x${this.bytes.reduce((l,n)=>l+n.toString(16).padStart(2,"0"),"")}`}toJSON(){return this.toString()}get valid(){let l=K.leadingZeros(this.bytes[0]);if(l===8)return!1;if(this.bytes.length!==1+l)return!1;return!0}get unknown(){let l=K.leadingZeros(this.bytes[0]);if(this.bytes[0]!==255>>l)return!1;for(let n of this.bytes.slice(1))if(n!==255)return!1;return!0}static fromBigInt(l){if(l===0n)return new K(new Uint8Array(1));let n=Math.ceil(K.bitLength(l)/7),b=new Uint8Array(n);for(let r=n-1;l>0;r--)b[r]=Number(l&0xffn),l>>=8n;return b[0]|=128>>n-1,new K(b)}static fromNumber(l){if(l===0)return new K(new Uint8Array(1));let n=Math.ceil(K.bitLength(BigInt(l))/7),b=new Uint8Array(n);for(let r=n-1;l>0;r--)b[r]=l&255,l>>=8;return b[0]|=128>>n-1,new K(b)}static leadingZeros(l){return Math.clz32(l)-24}static bitLength(l){return l.toString(2).length}}var T={};el(T,{VoidElement:()=>{{return wl}},VintElement:()=>{{return $l}},UnknownElement:()=>{{return Zl}},UintElement:()=>{{return J}},UTF8Element:()=>{{return R}},Stream:()=>{{return f}},SchemaStream:()=>{{return ul}},SchemaElement:()=>{{return E}},FloatElement:()=>{{return z}},EnumElement:()=>{{return S}},Element:()=>{{return F}},Crc32Element:()=>{{return il}},BytesElement:()=>{{return d}},BitMaskElement:()=>{{return An}}});class F{l;n;b;constructor(l,n,b){this.id=l;this.dataSize=n;this.data=b}get size(){return this.id.size+this.dataSize.size+this.data.size}get stream(){return new f(this.data)}get children(){return this.stream.children}static async fromBlob(l){const b=await l.slice(0,Math.min(l.size,16)).arrayBuffer(),r=K.fromBytes(new Uint8Array(b)),c=K.fromBytes(new Uint8Array(b.slice(r.size))),y=c.bigint,e=r.size+c.size,p=e+Number(y),o=l.slice(e,p);return new F(r,c,o)}}class f{l;cachedChildren=[];constructor(l){this.blob=l}get cachedChildrenSize(){return this.cachedChildren.reduce((l,n)=>l+n.size,0)}async*childrenGenerator(){for(let b of this.cachedChildren)yield b;let l=this.cachedChildrenSize;const n=this.blob;while(l<n.size){const b=await F.fromBlob(n.slice(l));this.cachedChildren.push(b),l+=b.size,yield b}if(l!==this.cachedChildrenSize)throw new Error("offset !== this.cachedChildrenSize")}get children(){return this.childrenGenerator()}}class E{l;n;static id;static level;static name;static knownChildren=[];static mandatory=!1;static multiple=!0;static leaf=!1;static cachedFor;static cachedKnownChildrenMap=new Map;_constructor;cache=new Map;constructor(l,n){this.element=l;this.parent=n;this._constructor=this.constructor;const b=this.constructor.id,r=this.constructor.name;if(this.element.id.id!==b&&b!==0)throw new Error(`Expected ID ${this.constructor.id}`);if(n!==void 0){const c=n.constructor.name,y=this.constructor.level,e=n.constructor.level;if(y!==void 0&&y!==e+1)throw new Error(`${r} (level ${y}) cannot be a child of ${c} (level ${e})`)}}async cached(l,n){if(this.cache.has(l))return this.cache.get(l);const b=n();return this.cache.set(l,b),b}get id(){return this._constructor.id}get level(){return this._constructor.level}get name(){return this._constructor.name}get knownChildren(){return this._constructor.knownChildren}get mandatory(){return this._constructor.mandatory}get multiple(){return this._constructor.multiple}get leaf(){return this._constructor.leaf}get knownChildrenMap(){const l=this._constructor;if(l.cachedFor!==l.id)l.cachedKnownChildrenMap=void 0;if(l.cachedKnownChildrenMap!==void 0)return l.cachedKnownChildrenMap;const n=new Map;if(l.knownChildren!==void 0)for(let b of l.knownChildren)n.set(b.id,b);return l.cachedKnownChildrenMap=n,l.cachedFor=l.id,n}get stream(){if(this.constructor.leaf)throw new Error("Cannot get stream of a leaf element");return new Tn(this.element.stream,this)}get value(){return}toString(){const l=this.constructor.name;if(this.leaf)return`<${l} size="${this.element.size}" dataSize="${this.element.dataSize.number}" />`;return`<${l} />`}get children(){const l=this.stream;if(l===void 0)throw new Error("Cannot get children of a leaf element");return l.children}maybeOne(l,n){return this.stream.maybeOne(l,n)}one(l,n){return this.stream.one(l,n)}many(l,n){return this.stream.many(l,n)}async toXMLParts(l,n="\t",b=""){const r=this.constructor.level;if(this.constructor.leaf||l!==void 0&&r!==void 0&&r>=l)return[`${b}${this.toString()}\n`];let y="";if(typeof n==="number")y=" ".repeat(n);else if(typeof n==="string")y=n;else throw new Error("Invalid indent");const e=b+y;let p=[];const o=this.stream;if(o!==void 0)p.push(`${b}<${this.constructor.name}>\n`),p.push(...await o.toXMLParts(l,n,e)),p.push(`${b}</${this.constructor.name}>\n`);else p.push(`${b}<${this.constructor.name} />\n`);return p}async toXML(l,n="\t",b=""){return(await this.toXMLParts(l,n,b)).join("")}}class Zl extends E{l;n;static id=0;static level=void 0;static name="Unknown";constructor(l,n){super(l,n);this.element=l;this.parent=n}async toXMLParts(l,n="\t",b=""){return[`${b}${this.toString()}\n`]}toString(){return`<Unknown id="${this.element.id.toString()}" />`}}class R extends E{static leaf=!0;cachedValue;async getValue(){if(this.cachedValue!==void 0)return this.cachedValue;const l=await this.element.data.arrayBuffer(),b=(new TextDecoder()).decode(l).replace(/\0.*$/g,"");return this.cachedValue=b,b}get value(){return this.getValue()}async toXMLParts(l,n="\t",b=""){const r=await this.getValue();return[`${b}<${this.constructor.name}>${r}</${this.constructor.name}>\n`]}}class J extends E{static leaf=!0;cachedValue;async getBigintValue(){if(this.cachedValue!==void 0)return this.cachedValue;const l=await this.element.data.arrayBuffer(),n=new Uint8Array(l);let b=0n;for(let r=0;r<n.length;r++)b=b<<8n|BigInt(n[r]);return this.cachedValue=b,b}get value(){return this.getBigintValue().then((l)=>Number(l))}get bigIntValue(){return this.getBigintValue()}async toXMLParts(l,n="\t",b=""){const r=await this.getBigintValue();return[`${b}<${this.constructor.name}>${r}</${this.constructor.name}>\n`]}}class z extends E{static leaf=!0;cachedValue;async getValue(){if(this.cachedValue!==void 0)return this.cachedValue;const l=await this.element.data.arrayBuffer(),n=new DataView(l);switch(l.byteLength){case 0:this.cachedValue=0;break;case 4:this.cachedValue=n.getFloat32(0);break;case 8:this.cachedValue=n.getFloat64(0);break;default:throw new Error("Invalid float size")}return this.cachedValue}get value(){return this.getValue()}async toXMLParts(l,n="\t",b=""){const r=await this.getValue();return[`${b}<${this.constructor.name}>${r}</${this.constructor.name}>\n`]}}class wl extends E{static id=236;static leaf=!0;get value(){return Promise.resolve()}}class il extends E{static id=191;static name="CRC-32";static leaf=!0;async getValue(){const l=await this.element.data.arrayBuffer();return new DataView(l).getUint32(0)}get value(){return this.getValue()}}class d extends E{static leaf=!0;cachedValue;async getValue(){if(this.cachedValue!==void 0)return this.cachedValue;const l=await this.element.data.arrayBuffer();return this.cachedValue=l,l}get value(){return this.getValue()}}class $l extends E{static leaf=!0;cachedValue;async getValue(){if(this.cachedValue!==void 0)return this.cachedValue;const l=await this.element.data.arrayBuffer();return this.cachedValue=new K(l),this.cachedValue}get value(){return this.getValue()}async toXMLParts(l,n="\t",b=""){const r=await this.getValue();return[`${b}<${this.constructor.name}>${r.number}</${this.constructor.name}>\n`]}}class S extends E{static leaf=!0;static values;cachedValue;async getValue(){if(this.cachedValue!==void 0)return this.cachedValue;const l=await this.element.data.arrayBuffer(),n=new Uint8Array(l);let b=0;for(let r=0;r<n.length;r++)b=b<<8|n[r];return b}get value(){return this.getValue().then((l)=>this.constructor.values[l])}}class An extends E{static leaf=!0;static values;cachedValue;async getValue(){if(this.cachedValue!==void 0)return this.cachedValue;const l=await this.element.data.arrayBuffer(),n=new Uint8Array(l);let b=0;for(let r=0;r<n.length;r++)b=b<<8|n[r];return b}get value(){return this.getValue().then((l)=>{const n=new Set;for(let b=0;b<8;b++)if((l&1<<b)!==0)n.add(this.constructor.values[b]);return n})}}class ul{l;n;static knownChildren=[];static cachedKnownChildrenMap;constructor(l,n){this.stream=l;this.parent=n}get knownChildrenMap(){const l=this.constructor;if(l.cachedKnownChildrenMap!==void 0)return l.cachedKnownChildrenMap;const n=new Map;if(l.knownChildren!==void 0)for(let b of l.knownChildren)n.set(b.id,b);return l.cachedKnownChildrenMap=n,n}async*childrenGenerator(){for await(let l of this.stream.children){const n=l.id.id,b=this.knownChildrenMap.get(n);if(b!==void 0)yield new b(l,this);else if(n===wl.id)yield new wl(l,this.parent);else if(n===il.id)yield new il(l,this.parent);else yield new Zl(l,this.parent)}}get children(){return this.childrenGenerator()}async maybeOne(l,n){for await(let b of this.stream.children){if(b.id.id===n?.before?.id)break;if(b.id.id===l.id){if(l===E)throw new Error("Cannot use SchemaElement as a type");return new l(b,this.parent)}}}async one(l,n){const b=await this.maybeOne(l,n);if(b===void 0)throw new Error(`Expected ${l.name}`);return b}async*many(l,n){for await(let b of this.stream.children)if(b.id.id===l.id){if(l===E)throw new Error("Cannot use SchemaElement as a type");yield new l(b,this.parent)}else if(b.id.id===n?.before?.id)break}async toXMLParts(l,n="\t",b=""){const r=[];for await(let c of this.children)r.push(...await c.toXMLParts(l,n,b));return r}}class Tn extends ul{constructor(l,n){super(l,n)}get knownChildrenMap(){return this.parent.knownChildrenMap}}var lb={};el(lb,{File:()=>{{return Xl}}});class M extends E{l;n;static id=524531317;static level=1;static name="Cluster";static get knownChildren(){return[Kl,ql]}constructor(l,n){super(l);this.element=l;this.parent=n}get timestamp(){return this.one(Kl).then((l)=>l.value)}get simpleBlocks(){return this.many(ql)}}class Kl extends J{l;n;static id=231;static level=2;static name="Timestamp";constructor(l,n){super(l);this.element=l;this.parent=n}}var jb=["none","Xiph","fixed-size","EBML"];class ql extends E{l;n;static id=163;static level=2;static name="SimpleBlock";static leaf=!0;constructor(l,n){super(l);this.element=l;this.parent=n}cachedTrackNumber;cachedTrackNumberSize;async getTrackNumber(){if(this.cachedTrackNumber)return this.cachedTrackNumber;const l=await this.element.data,n=await K.fromBlob(l);return this.cachedTrackNumber=n.number,this.cachedTrackNumberSize=n.size,this.cachedTrackNumber}get trackNumber(){return this.getTrackNumber()}cachedTimestamp;cachedTimestampSize=2;async getTimestamp(){if(this.cachedTimestamp)return this.cachedTimestamp;await this.getTrackNumber();const l=this.cachedTrackNumberSize,n=await this.element.data.slice(l,l+2).arrayBuffer(),b=new DataView(n);return this.cachedTimestamp=b.getInt16(0,!1),this.cachedTimestamp}get timestamp(){return this.getTimestamp()}cachedHeaderFlags;cachedHeaderFlagsSize=1;async getHeaderFlags(){if(this.cachedHeaderFlags)return this.cachedHeaderFlags;await this.getTimestamp();const l=this.cachedTrackNumberSize+this.cachedTimestampSize,n=await this.element.data.slice(l,l+1).arrayBuffer(),b=new Uint8Array(n);return this.cachedHeaderFlags=b[0],this.cachedHeaderFlags}get headerFlags(){return this.getHeaderFlags()}get keyframe(){return this.getHeaderFlags().then((l)=>!!(l&128))}get invisible(){return this.getHeaderFlags().then((l)=>!!(l&8))}get lacing(){const l=this.getHeaderFlags().then((b)=>(b&6)>>1);return l.then((b)=>jb[b]).then((b)=>{if(b===void 0)throw new Error(`Invalid lacing value: ${l}`);return b})}get discardable(){return this.getHeaderFlags().then((l)=>!!(l&1))}cachedFrameCount;cachedFrameCountSize;async getFrameCount(){if(this.cachedFrameCount)return this.cachedFrameCount;const l=await this.lacing;if(l==="none")return this.cachedFrameCount=1,this.cachedFrameCountSize=0,1;const n=this.cachedTrackNumberSize+2+1,b=this.element.data.slice(n);if(l==="Xiph"||l==="fixed-size"||l==="EBML"){const r=new Uint8Array(await b.slice(0,1).arrayBuffer());if(r.length===0)throw new Error("Invalid Xiph lacing");return this.cachedFrameCount=r[0]+1,this.cachedFrameCountSize=1,this.cachedFrameCount}else throw new Error(`Invalid lacing value: ${l}`)}get frameCount(){return this.getFrameCount()}cachedFrameSizes;cachedFrameSizesSize;async getFrameSizes(){const l=await this.trackNumber,n=await this.timestamp;if(this.cachedFrameSizes)return this.cachedFrameSizes;await this.getFrameCount();const b=await this.lacing,r=this.cachedTrackNumberSize+this.cachedTimestampSize+this.cachedHeaderFlagsSize+this.cachedFrameCountSize;if(b==="none"){const y=this.element.data.size-r;return this.cachedFrameSizes=[y],this.cachedFrameSizesSize=0,[y]}else if(b==="Xiph"){const c=this.element.data.slice(r),y=await this.getFrameCount(),e=[];let p=0;for(let i=0;i<y-1;i++){let $=0,m;do{const U=await c.slice(p,p+1).arrayBuffer();m=new Uint8Array(U)[0],$+=m,p++}while(m===255)}const o=c.size-p;return e.push(o),this.cachedFrameSizes=e,this.cachedFrameSizesSize=p,e}else if(b==="fixed-size"){const c=this.element.data.slice(r),y=await this.getFrameCount(),e=Math.floor(c.size/y),p=new Array(y).fill(e);return this.cachedFrameSizes=p,this.cachedFrameSizesSize=0,p}else if(b==="EBML"){const c=await this.getFrameCount(),y=this.element.data.slice(r),e=[];let p=0,o=0;const i=await K.fromBlob(y.slice(p));e.push(i.number),p+=i.size,o+=i.number;for(let m=1;m<c-1;m++){const U=await K.fromBlob(y.slice(p)),g=U.number-(2**(7*U.size-1)-1),H=e[m-1]+g;e.push(H),p+=U.size,o+=H}const $=y.size-p-o;return e.push($),this.cachedFrameSizes=e,this.cachedFrameSizesSize=p,e}else throw new Error(`Invalid lacing value: ${b}`)}get frames(){return async function*(){const l=await this.getFrameSizes();let n=this.cachedTrackNumberSize+this.cachedTimestampSize+this.cachedHeaderFlagsSize+this.cachedFrameCountSize+this.cachedFrameSizesSize;for(let b of l){const r=await this.element.data.slice(n,n+b).arrayBuffer();yield new Uint8Array(r),n+=b}}.bind(this)()}get data(){return this.getFrameSizes().then((l)=>{let n=this.cachedTrackNumberSize+this.cachedTimestampSize+this.cachedHeaderFlagsSize+this.cachedFrameCountSize+this.cachedFrameSizesSize;return this.element.data.slice(n).arrayBuffer()})}async toXMLParts(l,n="\t",b=""){return[`${b}<${this.constructor.name} track="${await this.trackNumber}" timestamp="${await this.timestamp}" framesizes="${JSON.stringify(await this.getFrameSizes())}" />\n`]}}class I extends E{l;n;static id=475249515;static level=1;static name="Cues";static get knownChildren(){return[Cl]}constructor(l,n){super(l);this.element=l;this.parent=n}get cuePoints(){return this.many(Cl)}}class Cl extends E{l;n;static id=187;static level=2;static name="CuePoint";static get knownChildren(){return[Pl,Nl]}constructor(l,n){super(l);this.element=l;this.parent=n}get cueTime(){return this.one(Pl).then((l)=>l.value)}get cueTrackPositions(){return this.many(Nl)}}class Pl extends J{l;n;static id=179;static level=3;static name="CueTime";constructor(l,n){super(l);this.element=l;this.parent=n}}class Nl extends E{l;n;static id=183;static level=3;static name="CueTrackPositions";static get knownChildren(){return[Rl,Ml,Bn,Fn]}constructor(l,n){super(l);this.element=l;this.parent=n}get cueTrack(){return this.one(Rl).then((l)=>l.value)}get cueClusterPosition(){return this.one(Ml).then((l)=>l.value)}}class Rl extends J{l;n;static id=247;static level=4;static name="CueTrack";constructor(l,n){super(l);this.element=l;this.parent=n}}class Ml extends J{l;n;static id=241;static level=4;static name="CueClusterPosition";constructor(l,n){super(l);this.element=l;this.parent=n}async getReferencedElement(){const l=await this.value,n=this.parent.parent.parent.parent,b=n.element.data.slice(l),r=await F.fromBlob(b);return new M(r,n)}get referencedElement(){return this.getReferencedElement()}}class Bn extends J{l;n;static id=240;static level=4;static name="CueRelativePosition";constructor(l,n){super(l);this.element=l;this.parent=n}}class Fn extends J{l;n;static id=178;static level=4;static name="CueDuration";constructor(l,n){super(l);this.element=l;this.parent=n}}class v extends E{l;n;static id=357149030;static level=1;static name="Info";static get knownChildren(){return[Vl,On,Dn,In,jl]}constructor(l,n){super(l);this.element=l;this.parent=n}get timestampScale(){return this.one(Vl).then((l)=>l.value)}get duration(){return this.one(jl).then((l)=>l.value)}}class Vl extends J{l;n;static id=2807729;static level=2;static name="TimestampScale";constructor(l,n){super(l);this.element=l;this.parent=n}}class On extends R{l;n;static id=19840;static level=2;static name="MuxingApp";constructor(l,n){super(l);this.element=l;this.parent=n}}class Dn extends R{l;n;static id=22337;static level=2;static name="WritingApp";constructor(l,n){super(l);this.element=l;this.parent=n}}class In extends d{l;n;static id=29604;static level=2;static name="SegmentUUID";constructor(l,n){super(l);this.element=l;this.parent=n}}class jl extends z{l;n;static id=17545;static level=2;static name="Duration";constructor(l,n){super(l);this.element=l;this.parent=n}}class Al extends E{l;n;static id=19899;static level=2;static name="Seek";static get knownChildren(){return[Tl,Bl]}constructor(l,n){super(l);this.element=l;this.parent=n}get seekID(){return this.one(Tl)}get seekPosition(){return this.one(Bl)}}class tl extends E{l;n;static id=290298740;static level=1;static name="SeekHead";static knownChildren=[Al];constructor(l,n){super(l);this.element=l;this.parent=n}get seeks(){return this.many(Al)}}class Tl extends $l{l;n;static id=21419;static level=3;static name="SeekID";constructor(l,n){super(l);this.element=l;this.parent=n}}class Bl extends J{l;n;static id=21420;static level=3;static name="SeekPosition";constructor(l,n){super(l);this.element=l;this.parent=n}async getReferencedElement(){const l=await this.value,n=this.parent.parent.parent,b=n.element.data.slice(l),r=await F.fromBlob(b),c=[tl,v,M,k,I,ol];for(let y of c)if(y.id===r.id.id)return new y(r,n);throw new Error(`Unknown element type ${r.id.toString()}, at position ${l}`)}get referencedElement(){return this.getReferencedElement()}}class ol extends E{l;n;static id=307544935;static level=1;static name="Tags";static get knownChildren(){return[dn]}constructor(l,n){super(l);this.element=l;this.parent=n}}class dn extends E{l;n;static id=29555;static level=2;static name="Tag";static get knownChildren(){return[an,xn]}constructor(l,n){super(l);this.element=l;this.parent=n}}class an extends E{l;n;static id=25536;static level=3;static name="Targets";static get knownChildren(){return[Ln,fn,vn]}constructor(l,n){super(l);this.element=l;this.parent=n}}class Ln extends J{l;n;static id=26826;static level=4;static name="TargetTypeValue";constructor(l,n){super(l);this.element=l;this.parent=n}}class fn extends R{l;n;static id=25546;static level=4;static name="TargetType";constructor(l,n){super(l);this.element=l;this.parent=n}}class xn extends E{l;n;static id=26568;static level=3;static name="SimpleTag";static get knownChildren(){return[zn,Fl,Sn,Fl]}constructor(l,n){super(l);this.element=l;this.parent=n}}class zn extends R{l;n;static id=17827;static level=4;static name="TagName";constructor(l,n){super(l);this.element=l;this.parent=n}}class Fl extends R{l;n;static id=17530;static level=4;static name="TagLanguage";constructor(l,n){super(l);this.element=l;this.parent=n}}class Sn extends R{l;n;static id=17543;static level=4;static name="TagString";constructor(l,n){super(l);this.element=l;this.parent=n}}class vn extends J{l;n;static id=25541;static level=4;static name="TagTrackUID";constructor(l,n){super(l);this.element=l;this.parent=n}}class k extends E{l;n;static id=374648427;static level=1;static name="Tracks";static get knownChildren(){return[Ol]}constructor(l,n){super(l);this.element=l;this.parent=n}get tracks(){return this.many(Ol)}}class Ol extends E{l;n;static id=174;static level=2;static name="TrackEntry";static get knownChildren(){return[Dl,Il,dl,Ll,kn,al,fl,nn,ll,bn,rn,un,s]}constructor(l,n){super(l);this.element=l;this.parent=n}get trackNumber(){return this.one(Dl).then((l)=>l.value)}get trackUID(){return this.one(Il).then((l)=>l.value)}get trackType(){return this.one(dl).then((l)=>l.value)}get defaultDuration(){return this.maybeOne(Ll).then((l)=>l===void 0?void 0:l.value)}get trackName(){return this.maybeOne(al).then((l)=>l===void 0?void 0:l.value)}get language(){return this.maybeOne(fl).then((l)=>l===void 0?void 0:l.value)}get codecID(){return this.one(nn).then((l)=>l.value)}get video(){return this.maybeOne(rn)}get audio(){return this.maybeOne(un)}get codecPrivate(){return this.maybeOne(ll).then((l)=>l===void 0?void 0:l.value)}get codecName(){return this.maybeOne(bn).then((l)=>l===void 0?void 0:l.value)}async getContentEncodings(){const l=await this.maybeOne(s);if(l===void 0)return;return l.many(hl)}get contentEncodings(){return this.getContentEncodings()}}class Dl extends J{l;n;static id=215;static level=3;static name="TrackNumber";constructor(l,n){super(l);this.element=l;this.parent=n}}class Il extends d{l;n;static id=29637;static level=3;static name="TrackUID";constructor(l,n){super(l);this.element=l;this.parent=n}}class dl extends E{l;n;static id=131;static level=3;static name="TrackType";static leaf=!0;constructor(l,n){super(l);this.element=l;this.parent=n}async getValue(){const l=await this.element.data.arrayBuffer(),n=new Uint8Array(l);let b=0;for(let r=0;r<n.length;r++)b=b<<8|n[r];switch(b){case 1:return"video";case 2:return"audio";case 3:return"complex";case 16:return"logo";case 17:return"subtitle";case 18:return"buttons";case 32:return"control";default:throw new Error(`Unknown track type ${b}`)}}get value(){return this.getValue()}}class al extends R{l;n;static id=21358;static level=3;static name="Name";constructor(l,n){super(l);this.element=l;this.parent=n}}class Ll extends J{l;n;static id=2352003;static level=3;static name="DefaultDuration";constructor(l,n){super(l);this.element=l;this.parent=n}}class kn extends J{l;n;static id=156;static level=3;static name="FlagLacing";constructor(l,n){super(l);this.element=l;this.parent=n}}class fl extends R{l;n;static id=2274716;static level=3;static name="Language";constructor(l,n){super(l);this.element=l;this.parent=n}}class s extends E{l;n;static id=28032;static level=3;static name="ContentEncodings";static get knownChildren(){return[hl]}cachedOrderedEncodings;constructor(l,n){super(l);this.element=l;this.parent=n}get contentEncodings(){return this.many(hl)}async decode(l){if(this.cachedOrderedEncodings===void 0){const n=new Map;for await(let r of this.contentEncodings){const c=await r.order;n.set(c??0,r)}const b=Array.from(n.entries()).sort(([r],[c])=>r-c).map(([,r])=>r);this.cachedOrderedEncodings=b}for(let n of this.cachedOrderedEncodings)l=await n.decode(l);return l}}class hl extends E{l;n;static id=25152;static level=4;static name="ContentEncoding";static get knownChildren(){return[xl,zl,Sl,vl,ln]}constructor(l,n){super(l);this.element=l;this.parent=n}get order(){return this.maybeOne(xl).then((l)=>l?.value)}get scope(){return this.one(zl).then((l)=>l.value)}get type(){return this.cached("type",()=>this.maybeOne(Sl).then((l)=>l?.value))}get compression(){return this.cached("compression",()=>this.maybeOne(vl))}get encryption(){return this.maybeOne(ln)}async decode(l){const n=await this.type??"compression";if(n==="compression"){const b=await this.compression;if(b===void 0)return l;return b.decompress(l)}else throw new Error(`Unimplemented ContentEncodingType ${n}`)}}class xl extends J{l;n;static id=20529;static level=5;static name="ContentEncodingOrder";constructor(l,n){super(l);this.element=l;this.parent=n}}var Ab=["block","private","next"];class zl extends S{l;n;static id=20530;static level=5;static name="ContentEncodingScope";static values=Ab;constructor(l,n){super(l);this.element=l;this.parent=n}}var Tb=["compression","encryption"];class Sl extends S{l;n;static id=20531;static level=5;static name="ContentEncodingType";static values=Tb;constructor(l,n){super(l);this.element=l;this.parent=n}}class vl extends E{l;n;static id=20532;static level=5;static name="ContentCompression";static get knownChildren(){return[kl,sl]}constructor(l,n){super(l);this.element=l;this.parent=n}get algo(){return this.one(kl).then((l)=>l.value)}get settings(){return this.one(sl).then((l)=>l.value)}async decompress(l){const n=await this.algo;if(n==="headerStripping"){const b=await this.settings,r=new Uint8Array(b.byteLength+l.byteLength);return r.set(new Uint8Array(b),0),r.set(new Uint8Array(l),b.byteLength),r.buffer}else throw new Error(`Unimplemented compression algorithm ${n}`)}}var Bb=["zlib","bzlib","lzo1x","headerStripping"];class kl extends S{l;n;static id=16980;static level=6;static name="ContentCompAlgo";static values=Bb;constructor(l,n){super(l);this.element=l;this.parent=n}}class sl extends d{l;n;static id=16981;static level=6;static name="ContentCompSettings";constructor(l,n){super(l);this.element=l;this.parent=n}}class ln extends E{l;n;static id=20533;static level=5;static name="ContentEncryption";static get knownChildren(){return[]}constructor(l,n){super(l);this.element=l;this.parent=n}}class nn extends R{l;n;static id=134;static level=3;static name="CodecID";constructor(l,n){super(l);this.element=l;this.parent=n}}class ll extends d{l;n;static id=25506;static level=3;static name="CodecPrivate";constructor(l,n){super(l);this.element=l;this.parent=n}}class bn extends R{l;n;static id=2459272;static level=3;static name="CodecName";constructor(l,n){super(l);this.element=l;this.parent=n}}class rn extends E{l;n;static id=224;static level=4;static name="Video";static get knownChildren(){return[cn,yn,pn,en]}constructor(l,n){super(l);this.element=l;this.parent=n}get pixelWidth(){return this.one(cn).then((l)=>l.value)}get pixelHeight(){return this.one(yn).then((l)=>l.value)}get displayWidth(){return this.one(pn).then((l)=>l.value)}get displayHeight(){return this.one(en).then((l)=>l.value)}}class cn extends J{l;n;static id=176;static level=5;static name="PixelWidth";constructor(l,n){super(l);this.element=l;this.parent=n}}class yn extends J{l;n;static id=186;static level=5;static name="PixelHeight";constructor(l,n){super(l);this.element=l;this.parent=n}}class pn extends J{l;n;static id=21680;static level=5;static name="DisplayWidth";constructor(l,n){super(l);this.element=l;this.parent=n}}class en extends J{l;n;static id=21690;static level=5;static name="DisplayHeight";constructor(l,n){super(l);this.element=l;this.parent=n}}class un extends E{l;n;static id=225;static level=4;static name="Audio";static get knownChildren(){return[tn,on,mn]}constructor(l,n){super(l);this.element=l;this.parent=n}get samplingFrequency(){return this.one(tn).then((l)=>l.value)}get channels(){return this.one(on).then((l)=>l.value)}get bitDepth(){return this.maybeOne(mn).then((l)=>l?.value)}}class tn extends z{l;n;static id=181;static level=5;static name="SamplingFrequency";constructor(l,n){super(l);this.element=l;this.parent=n}}class on extends J{l;n;static id=159;static level=5;static name="Channels";constructor(l,n){super(l);this.element=l;this.parent=n}}class mn extends J{l;n;static id=25188;static level=5;static name="BitDepth";constructor(l,n){super(l);this.element=l;this.parent=n}}class Gl extends E{l;static id=440786851;static level=0;static name="EBMLHead";static leaf=!0;constructor(l){super(l);this.element=l}}class x extends E{l;static id=408125543;static level=0;static name="Segment";static knownChildren=[tl,v,k,M,I,ol];constructor(l){super(l);this.element=l}get info(){return this.one(v,{before:M})}get tracks(){return this.maybeOne(k,{before:M})}async getCues(l){for await(let n of this.many(tl,{before:M}))for await(let b of n.seeks)if((await b.seekID.then((c)=>c.value)).id===I.id){const y=await(await b.seekPosition).referencedElement;if(!(y instanceof I))throw new Error("Referenced element is not Cues");return y}if(l)return;for await(let n of this.element.children){if(n.id.id===I.id)return new I(n,this);if(n.id.id===M.id)break}return}get cues(){return this.getCues()}get clusters(){return this.many(M)}async seekCluster(l){const n=this.element.data.slice(l),b=await F.fromBlob(n);return new M(b,this)}async*seekClusters(l){const n=this.element.data.slice(l),b=new f(n);for await(let r of b.children){if(r.id.id!==M.id)break;yield new M(r,this)}}}class Xl extends ul{l;static knownChildren=[Gl,x];constructor(l){super(l);this.stream=l}async*segmentsGenerator(){let l=0;for await(let n of this.stream.children){switch(l%2){case 0:if(n.id.id!==Gl.id)throw new Error("Expected EBMLHead");break;case 1:if(n.id.id!==x.id)throw new Error("Expected Segment");yield new x(n);break}l++}}get segments(){return this.segmentsGenerator()}async toXML(l,n="\t"){return(await this.toXMLParts(l,n)).join("")}}var Cb={};el(Cb,{polyfill:()=>{{return zb}},MKVVideoPlayer:()=>{{return Nn}},MKVToMP4Muxer:()=>{{return Pn}}});var yb={};el(yb,{FetchBlobLike:()=>{{return cl}},CacheBlobLike:()=>{{return Ql}}});var nl=typeof performance==="object"&&performance&&typeof performance.now==="function"?performance:Date,bb=new Set,En=typeof process==="object"&&!!process?process:{},rb=(l,n,b,r)=>{typeof En.emitWarning==="function"?En.emitWarning(l,n,b,r):console.error(`[${b}] ${n}: ${l}`)},Jl=globalThis.AbortController,nb=globalThis.AbortSignal;if(typeof Jl==="undefined"){nb=class b{onabort;_onabort=[];reason;aborted=!1;addEventListener(r,c){this._onabort.push(c)}},Jl=class b{constructor(){n()}signal=new nb;abort(r){if(this.signal.aborted)return;this.signal.reason=r,this.signal.aborted=!0;for(let c of this.signal._onabort)c(r);this.signal.onabort?.(r)}};let l=En.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1";const n=()=>{if(!l)return;l=!1,rb("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",n)}}var Fb=(l)=>!bb.has(l),Zr=Symbol("type"),a=(l)=>l&&l===Math.floor(l)&&l>0&&isFinite(l),cb=(l)=>!a(l)?null:l<=Math.pow(2,8)?Uint8Array:l<=Math.pow(2,16)?Uint16Array:l<=Math.pow(2,32)?Uint32Array:l<=Number.MAX_SAFE_INTEGER?ml:null;class ml extends Array{constructor(l){super(l);this.fill(0)}}class bl{heap;length;static#u=!1;static create(l){const n=cb(l);if(!n)return[];bl.#u=!0;const b=new bl(l,n);return bl.#u=!1,b}constructor(l,n){if(!bl.#u)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new n(l),this.length=0}push(l){this.heap[this.length++]=l}pop(){return this.heap[--this.length]}}class rl{#u;#m;#w;#i;#q;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#c;#$;#r;#b;#l;#t;#E;#e;#y;#h;#p;#G;#X;#U;#J;#H;#o;static unsafeExposeInternals(l){return{starts:l.#X,ttls:l.#U,sizes:l.#G,keyMap:l.#r,keyList:l.#b,valList:l.#l,next:l.#t,prev:l.#E,get head(){return l.#e},get tail(){return l.#y},free:l.#h,isBackgroundFetch:(n)=>l.#n(n),backgroundFetch:(n,b,r,c)=>l.#N(n,b,r,c),moveToTail:(n)=>l.#K(n),indexes:(n)=>l.#Q(n),rindexes:(n)=>l.#Y(n),isStale:(n)=>l.#g(n)}}get max(){return this.#u}get maxSize(){return this.#m}get calculatedSize(){return this.#$}get size(){return this.#c}get fetchMethod(){return this.#q}get dispose(){return this.#w}get disposeAfter(){return this.#i}constructor(l){const{max:n=0,ttl:b,ttlResolution:r=1,ttlAutopurge:c,updateAgeOnGet:y,updateAgeOnHas:e,allowStale:p,dispose:o,disposeAfter:i,noDisposeOnSet:$,noUpdateTTL:m,maxSize:U=0,maxEntrySize:C=0,sizeCalculation:g,fetchMethod:H,noDeleteOnFetchRejection:w,noDeleteOnStaleGet:h,allowStaleOnFetchRejection:u,allowStaleOnFetchAbort:G,ignoreFetchAbort:X}=l;if(n!==0&&!a(n))throw new TypeError("max option must be a nonnegative integer");const W=n?cb(n):Array;if(!W)throw new Error("invalid max value: "+n);if(this.#u=n,this.#m=U,this.maxEntrySize=C||this.#m,this.sizeCalculation=g,this.sizeCalculation){if(!this.#m&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!=="function")throw new TypeError("sizeCalculation set to non-function")}if(H!==void 0&&typeof H!=="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#q=H,this.#H=!!H,this.#r=new Map,this.#b=new Array(n).fill(void 0),this.#l=new Array(n).fill(void 0),this.#t=new W(n),this.#E=new W(n),this.#e=0,this.#y=0,this.#h=bl.create(n),this.#c=0,this.#$=0,typeof o==="function")this.#w=o;if(typeof i==="function")this.#i=i,this.#p=[];else this.#i=void 0,this.#p=void 0;if(this.#J=!!this.#w,this.#o=!!this.#i,this.noDisposeOnSet=!!$,this.noUpdateTTL=!!m,this.noDeleteOnFetchRejection=!!w,this.allowStaleOnFetchRejection=!!u,this.allowStaleOnFetchAbort=!!G,this.ignoreFetchAbort=!!X,this.maxEntrySize!==0){if(this.#m!==0){if(!a(this.#m))throw new TypeError("maxSize must be a positive integer if specified")}if(!a(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#T()}if(this.allowStale=!!p,this.noDeleteOnStaleGet=!!h,this.updateAgeOnGet=!!y,this.updateAgeOnHas=!!e,this.ttlResolution=a(r)||r===0?r:1,this.ttlAutopurge=!!c,this.ttl=b||0,this.ttl){if(!a(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#R()}if(this.#u===0&&this.ttl===0&&this.#m===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#u&&!this.#m){if(Fb("LRU_CACHE_UNBOUNDED"))bb.add("LRU_CACHE_UNBOUNDED"),rb("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning","LRU_CACHE_UNBOUNDED",rl)}}getRemainingTTL(l){return this.#r.has(l)?1/0:0}#R(){const l=new ml(this.#u),n=new ml(this.#u);this.#U=l,this.#X=n,this.#M=(c,y,e=nl.now())=>{if(n[c]=y!==0?e:0,l[c]=y,y!==0&&this.ttlAutopurge){const p=setTimeout(()=>{if(this.#g(c))this.delete(this.#b[c])},y+1);if(p.unref)p.unref()}},this.#W=(c)=>{n[c]=l[c]!==0?nl.now():0},this.#_=(c,y)=>{if(l[y]){const e=l[y],p=n[y];if(!e||!p)return;c.ttl=e,c.start=p,c.now=b||r();const o=c.now-p;c.remainingTTL=e-o}};let b=0;const r=()=>{const c=nl.now();if(this.ttlResolution>0){b=c;const y=setTimeout(()=>b=0,this.ttlResolution);if(y.unref)y.unref()}return c};this.getRemainingTTL=(c)=>{const y=this.#r.get(c);if(y===void 0)return 0;const e=l[y],p=n[y];if(!e||!p)return 1/0;const o=(b||r())-p;return e-o},this.#g=(c)=>{const y=n[c],e=l[c];return!!e&&!!y&&(b||r())-y>e}}#W=()=>{};#_=()=>{};#M=()=>{};#g=()=>!1;#T(){const l=new ml(this.#u);this.#$=0,this.#G=l,this.#Z=(n)=>{this.#$-=l[n],l[n]=0},this.#V=(n,b,r,c)=>{if(this.#n(b))return 0;if(!a(r))if(c){if(typeof c!=="function")throw new TypeError("sizeCalculation must be a function");if(r=c(b,n),!a(r))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return r},this.#C=(n,b,r)=>{if(l[n]=b,this.#m){const c=this.#m-l[n];while(this.#$>c)this.#P(!0)}if(this.#$+=l[n],r)r.entrySize=b,r.totalCalculatedSize=this.#$}}#Z=(l)=>{};#C=(l,n,b)=>{};#V=(l,n,b,r)=>{if(b||r)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#Q({allowStale:l=this.allowStale}={}){if(this.#c)for(let n=this.#y;;){if(!this.#j(n))break;if(l||!this.#g(n))yield n;if(n===this.#e)break;else n=this.#E[n]}}*#Y({allowStale:l=this.allowStale}={}){if(this.#c)for(let n=this.#e;;){if(!this.#j(n))break;if(l||!this.#g(n))yield n;if(n===this.#y)break;else n=this.#t[n]}}#j(l){return l!==void 0&&this.#r.get(this.#b[l])===l}*entries(){for(let l of this.#Q())if(this.#l[l]!==void 0&&this.#b[l]!==void 0&&!this.#n(this.#l[l]))yield[this.#b[l],this.#l[l]]}*rentries(){for(let l of this.#Y())if(this.#l[l]!==void 0&&this.#b[l]!==void 0&&!this.#n(this.#l[l]))yield[this.#b[l],this.#l[l]]}*keys(){for(let l of this.#Q()){const n=this.#b[l];if(n!==void 0&&!this.#n(this.#l[l]))yield n}}*rkeys(){for(let l of this.#Y()){const n=this.#b[l];if(n!==void 0&&!this.#n(this.#l[l]))yield n}}*values(){for(let l of this.#Q())if(this.#l[l]!==void 0&&!this.#n(this.#l[l]))yield this.#l[l]}*rvalues(){for(let l of this.#Y())if(this.#l[l]!==void 0&&!this.#n(this.#l[l]))yield this.#l[l]}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(l,n={}){for(let b of this.#Q()){const r=this.#l[b],c=this.#n(r)?r.__staleWhileFetching:r;if(c===void 0)continue;if(l(c,this.#b[b],this))return this.get(this.#b[b],n)}}forEach(l,n=this){for(let b of this.#Q()){const r=this.#l[b],c=this.#n(r)?r.__staleWhileFetching:r;if(c===void 0)continue;l.call(n,c,this.#b[b],this)}}rforEach(l,n=this){for(let b of this.#Y()){const r=this.#l[b],c=this.#n(r)?r.__staleWhileFetching:r;if(c===void 0)continue;l.call(n,c,this.#b[b],this)}}purgeStale(){let l=!1;for(let n of this.#Y({allowStale:!0}))if(this.#g(n))this.delete(this.#b[n]),l=!0;return l}info(l){const n=this.#r.get(l);if(n===void 0)return;const b=this.#l[n],r=this.#n(b)?b.__staleWhileFetching:b;if(r===void 0)return;const c={value:r};if(this.#U&&this.#X){const y=this.#U[n],e=this.#X[n];if(y&&e){const p=y-(nl.now()-e);c.ttl=p,c.start=Date.now()}}if(this.#G)c.size=this.#G[n];return c}dump(){const l=[];for(let n of this.#Q({allowStale:!0})){const b=this.#b[n],r=this.#l[n],c=this.#n(r)?r.__staleWhileFetching:r;if(c===void 0||b===void 0)continue;const y={value:c};if(this.#U&&this.#X){y.ttl=this.#U[n];const e=nl.now()-this.#X[n];y.start=Math.floor(Date.now()-e)}if(this.#G)y.size=this.#G[n];l.unshift([b,y])}return l}load(l){this.clear();for(let[n,b]of l){if(b.start){const r=Date.now()-b.start;b.start=nl.now()-r}this.set(n,b.value,b)}}set(l,n,b={}){if(n===void 0)return this.delete(l),this;const{ttl:r=this.ttl,start:c,noDisposeOnSet:y=this.noDisposeOnSet,sizeCalculation:e=this.sizeCalculation,status:p}=b;let{noUpdateTTL:o=this.noUpdateTTL}=b;const i=this.#V(l,n,b.size||0,e);if(this.maxEntrySize&&i>this.maxEntrySize){if(p)p.set="miss",p.maxEntrySizeExceeded=!0;return this.delete(l),this}let $=this.#c===0?void 0:this.#r.get(l);if($===void 0){if($=this.#c===0?this.#y:this.#h.length!==0?this.#h.pop():this.#c===this.#u?this.#P(!1):this.#c,this.#b[$]=l,this.#l[$]=n,this.#r.set(l,$),this.#t[this.#y]=$,this.#E[$]=this.#y,this.#y=$,this.#c++,this.#C($,i,p),p)p.set="add";o=!1}else{this.#K($);const m=this.#l[$];if(n!==m){if(this.#H&&this.#n(m)){m.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:U}=m;if(U!==void 0&&!y){if(this.#J)this.#w?.(U,l,"set");if(this.#o)this.#p?.push([U,l,"set"])}}else if(!y){if(this.#J)this.#w?.(m,l,"set");if(this.#o)this.#p?.push([m,l,"set"])}if(this.#Z($),this.#C($,i,p),this.#l[$]=n,p){p.set="replace";const U=m&&this.#n(m)?m.__staleWhileFetching:m;if(U!==void 0)p.oldValue=U}}else if(p)p.set="update"}if(r!==0&&!this.#U)this.#R();if(this.#U){if(!o)this.#M($,r,c);if(p)this.#_(p,$)}if(!y&&this.#o&&this.#p){const m=this.#p;let U;while(U=m?.shift())this.#i?.(...U)}return this}pop(){try{while(this.#c){const l=this.#l[this.#e];if(this.#P(!0),this.#n(l)){if(l.__staleWhileFetching)return l.__staleWhileFetching}else if(l!==void 0)return l}}finally{if(this.#o&&this.#p){const l=this.#p;let n;while(n=l?.shift())this.#i?.(...n)}}}#P(l){const n=this.#e,b=this.#b[n],r=this.#l[n];if(this.#H&&this.#n(r))r.__abortController.abort(new Error("evicted"));else if(this.#J||this.#o){if(this.#J)this.#w?.(r,b,"evict");if(this.#o)this.#p?.push([r,b,"evict"])}if(this.#Z(n),l)this.#b[n]=void 0,this.#l[n]=void 0,this.#h.push(n);if(this.#c===1)this.#e=this.#y=0,this.#h.length=0;else this.#e=this.#t[n];return this.#r.delete(b),this.#c--,n}has(l,n={}){const{updateAgeOnHas:b=this.updateAgeOnHas,status:r}=n,c=this.#r.get(l);if(c!==void 0){const y=this.#l[c];if(this.#n(y)&&y.__staleWhileFetching===void 0)return!1;if(!this.#g(c)){if(b)this.#W(c);if(r)r.has="hit",this.#_(r,c);return!0}else if(r)r.has="stale",this.#_(r,c)}else if(r)r.has="miss";return!1}peek(l,n={}){const{allowStale:b=this.allowStale}=n,r=this.#r.get(l);if(r===void 0||!b&&this.#g(r))return;const c=this.#l[r];return this.#n(c)?c.__staleWhileFetching:c}#N(l,n,b,r){const c=n===void 0?void 0:this.#l[n];if(this.#n(c))return c;const y=new Jl,{signal:e}=b;e?.addEventListener("abort",()=>y.abort(e.reason),{signal:y.signal});const p={signal:y.signal,options:b,context:r},o=(g,H=!1)=>{const{aborted:w}=y.signal,h=b.ignoreFetchAbort&&g!==void 0;if(b.status)if(w&&!H){if(b.status.fetchAborted=!0,b.status.fetchError=y.signal.reason,h)b.status.fetchAbortIgnored=!0}else b.status.fetchResolved=!0;if(w&&!h&&!H)return $(y.signal.reason);const u=U;if(this.#l[n]===U)if(g===void 0)if(u.__staleWhileFetching)this.#l[n]=u.__staleWhileFetching;else this.delete(l);else{if(b.status)b.status.fetchUpdated=!0;this.set(l,g,p.options)}return g},i=(g)=>{if(b.status)b.status.fetchRejected=!0,b.status.fetchError=g;return $(g)},$=(g)=>{const{aborted:H}=y.signal,w=H&&b.allowStaleOnFetchAbort,h=w||b.allowStaleOnFetchRejection,u=h||b.noDeleteOnFetchRejection,G=U;if(this.#l[n]===U){if(!u||G.__staleWhileFetching===void 0)this.delete(l);else if(!w)this.#l[n]=G.__staleWhileFetching}if(h){if(b.status&&G.__staleWhileFetching!==void 0)b.status.returnedStale=!0;return G.__staleWhileFetching}else if(G.__returned===G)throw g},m=(g,H)=>{const w=this.#q?.(l,c,p);if(w&&w instanceof Promise)w.then((h)=>g(h===void 0?void 0:h),H);y.signal.addEventListener("abort",()=>{if(!b.ignoreFetchAbort||b.allowStaleOnFetchAbort){if(g(void 0),b.allowStaleOnFetchAbort)g=(h)=>o(h,!0)}})};if(b.status)b.status.fetchDispatched=!0;const U=new Promise(m).then(o,i),C=Object.assign(U,{__abortController:y,__staleWhileFetching:c,__returned:void 0});if(n===void 0)this.set(l,C,{...p.options,status:void 0}),n=this.#r.get(l);else this.#l[n]=C;return C}#n(l){if(!this.#H)return!1;const n=l;return!!n&&n instanceof Promise&&n.hasOwnProperty("__staleWhileFetching")&&n.__abortController instanceof Jl}async fetch(l,n={}){const{allowStale:b=this.allowStale,updateAgeOnGet:r=this.updateAgeOnGet,noDeleteOnStaleGet:c=this.noDeleteOnStaleGet,ttl:y=this.ttl,noDisposeOnSet:e=this.noDisposeOnSet,size:p=0,sizeCalculation:o=this.sizeCalculation,noUpdateTTL:i=this.noUpdateTTL,noDeleteOnFetchRejection:$=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:m=this.allowStaleOnFetchRejection,ignoreFetchAbort:U=this.ignoreFetchAbort,allowStaleOnFetchAbort:C=this.allowStaleOnFetchAbort,context:g,forceRefresh:H=!1,status:w,signal:h}=n;if(!this.#H){if(w)w.fetch="get";return this.get(l,{allowStale:b,updateAgeOnGet:r,noDeleteOnStaleGet:c,status:w})}const u={allowStale:b,updateAgeOnGet:r,noDeleteOnStaleGet:c,ttl:y,noDisposeOnSet:e,size:p,sizeCalculation:o,noUpdateTTL:i,noDeleteOnFetchRejection:$,allowStaleOnFetchRejection:m,allowStaleOnFetchAbort:C,ignoreFetchAbort:U,status:w,signal:h};let G=this.#r.get(l);if(G===void 0){if(w)w.fetch="miss";const X=this.#N(l,G,u,g);return X.__returned=X}else{const X=this.#l[G];if(this.#n(X)){const j=b&&X.__staleWhileFetching!==void 0;if(w){if(w.fetch="inflight",j)w.returnedStale=!0}return j?X.__staleWhileFetching:X.__returned=X}const W=this.#g(G);if(!H&&!W){if(w)w.fetch="hit";if(this.#K(G),r)this.#W(G);if(w)this.#_(w,G);return X}const N=this.#N(l,G,u,g),q=N.__staleWhileFetching!==void 0&&b;if(w){if(w.fetch=W?"stale":"refresh",q&&W)w.returnedStale=!0}return q?N.__staleWhileFetching:N.__returned=N}}get(l,n={}){const{allowStale:b=this.allowStale,updateAgeOnGet:r=this.updateAgeOnGet,noDeleteOnStaleGet:c=this.noDeleteOnStaleGet,status:y}=n,e=this.#r.get(l);if(e!==void 0){const p=this.#l[e],o=this.#n(p);if(y)this.#_(y,e);if(this.#g(e)){if(y)y.get="stale";if(!o){if(!c)this.delete(l);if(y&&b)y.returnedStale=!0;return b?p:void 0}else{if(y&&b&&p.__staleWhileFetching!==void 0)y.returnedStale=!0;return b?p.__staleWhileFetching:void 0}}else{if(y)y.get="hit";if(o)return p.__staleWhileFetching;if(this.#K(e),r)this.#W(e);return p}}else if(y)y.get="miss"}#A(l,n){this.#E[n]=l,this.#t[l]=n}#K(l){if(l!==this.#y){if(l===this.#e)this.#e=this.#t[l];else this.#A(this.#E[l],this.#t[l]);this.#A(this.#y,l),this.#y=l}}delete(l){let n=!1;if(this.#c!==0){const b=this.#r.get(l);if(b!==void 0)if(n=!0,this.#c===1)this.clear();else{this.#Z(b);const r=this.#l[b];if(this.#n(r))r.__abortController.abort(new Error("deleted"));else if(this.#J||this.#o){if(this.#J)this.#w?.(r,l,"delete");if(this.#o)this.#p?.push([r,l,"delete"])}if(this.#r.delete(l),this.#b[b]=void 0,this.#l[b]=void 0,b===this.#y)this.#y=this.#E[b];else if(b===this.#e)this.#e=this.#t[b];else{const c=this.#E[b];this.#t[c]=this.#t[b];const y=this.#t[b];this.#E[y]=this.#E[b]}this.#c--,this.#h.push(b)}}if(this.#o&&this.#p?.length){const b=this.#p;let r;while(r=b?.shift())this.#i?.(...r)}return n}clear(){for(let l of this.#Y({allowStale:!0})){const n=this.#l[l];if(this.#n(n))n.__abortController.abort(new Error("deleted"));else{const b=this.#b[l];if(this.#J)this.#w?.(n,b,"delete");if(this.#o)this.#p?.push([n,b,"delete"])}}if(this.#r.clear(),this.#l.fill(void 0),this.#b.fill(void 0),this.#U&&this.#X)this.#U.fill(0),this.#X.fill(0);if(this.#G)this.#G.fill(0);if(this.#e=0,this.#y=0,this.#h.length=0,this.#$=0,this.#c=0,this.#o&&this.#p){const l=this.#p;let n;while(n=l?.shift())this.#i?.(...n)}}}class cl{l;n;b;r;c;constructor(l,n,b,r,c){this.url=l;this.size=n;this.offset=b;this.cacheBlockSize=r;this.cache=c;this.url=l,this.size=n}static async fromUrl(l,n=16777216,b=1048576){const r=await fetch(l,{method:"HEAD"});if(!r.ok)throw new Error("Failed to fetch blob");const c=Number(r.headers.get("Content-Length"));return new cl(l,c,0,b,new rl({maxSize:n,sizeCalculation:(y)=>y.byteLength,fetchMethod:async(y)=>{const e=y*b,p=Math.min(e+b,c),o=await fetch(l,{headers:{Range:`bytes=${e}-${p-1}`},redirect:"follow"});if(!o.ok)throw new Error("Failed to fetch blob");if(o.status!==206)throw new Error("Server does not support range requests");return await o.arrayBuffer()}}))}slice(l=0,n=this.size){return n=Math.min(n,this.size),new cl(this.url,n-l,this.offset+l,this.cacheBlockSize,this.cache)}async arrayBuffer(){const l=new Uint8Array(this.size);let n=this.offset,b=0;while(b<this.size){const r=Math.floor(n/this.cacheBlockSize),c=n%this.cacheBlockSize,y=await this.cache.fetch(r),e=Math.min(this.size-b,y.byteLength-c);l.set(new Uint8Array(y,c,e),b),n+=e,b+=e}return l.buffer}}class Ql{n;b;r;cache;constructor(l,n=0,b=l.size,r=1048576,c=16777216){this.start=n;this.end=b;this.cacheBlockSize=r;if(l instanceof Ql){this.cacheBlockSize=l.cacheBlockSize,this.cache=l.cache,this.start=l.start+n,this.end=l.start+b;return}if(n<0)throw new Error("Start must be non-negative");if(b<n)throw new Error("End must be greater than or equal to start");this.cache=new rl({maxSize:c,sizeCalculation:(y)=>y.byteLength,fetchMethod:async(y)=>{const e=y*r,p=Math.min(e+r,l.size);return await l.slice(e,p).arrayBuffer()}})}get size(){return this.end-this.start}slice(l=0,n=this.size){if(l<0)throw new Error("Start must be non-negative");if(n<l)throw new Error("End must be greater than or equal to start");if(n>this.size)throw new Error("End must be less than or equal to size");return new Ql(this,l,n)}async arrayBuffer(){if(this.size===0)return new ArrayBuffer(0);const l=new Uint8Array(this.size);let n=this.start,b=0;while(b<this.size){const r=Math.floor(n/this.cacheBlockSize),c=n%this.cacheBlockSize,y=await this.cache.fetch(r),e=Math.min(this.size-b,y.byteLength-c);l.set(new Uint8Array(y,c,e),b),n+=e,b+=e}return l.buffer}}var ub=function(l){Yl.setBigUint64(0,BigInt(l),!1);const n=new Uint8Array(8);return n.set(_l,0),n},t=function(l){Yl.setUint32(0,l,!1);const n=new Uint8Array(4);return n.set(_l.slice(0,4),0),n},Ob=function(l){Yl.setInt32(0,l,!1);const n=new Uint8Array(4);return n.set(_l.slice(0,4),0),n},Q=function(l){Yl.setUint16(0,l,!1);const n=new Uint8Array(2);return n.set(_l.slice(0,2),0),n},P=function(l,n){return t((l&16777215)<<24|n)},V=function(l){return new Uint8Array(l)},pl=function(l,n){if(n!==void 0)l=l.padEnd(n," ").slice(0,n);const b=new Uint8Array(l.length);for(let r=0;r<l.length;r++)b[r]=l.charCodeAt(r);return b};function _(l,...n){const b=A.concat(...n);let r=8+b.build().length;return A.concat(t(r),pl(l),b)}var O=function(l){return(...n)=>_(l,...n)};function ob({majorBrand:l,minorVersion:n,compatibleBrands:b}){return _("ftyp",pl(l,4),t(n),...b.map((r)=>pl(r,4)))}function mb({timeScale:l,duration:n,nextTrackId:b}){return _("mvhd",P(0,0),V(8),t(l),t(n),Q(1),Q(0),[1,0],V(10),eb,V(24),t(b))}function gn({trackId:l,duration:n,width:b,height:r}){return _("tkhd",P(0,3),t(0),t(0),t(l),V(4),t(n??0),V(8),Q(0),Q(0),Q(0),V(2),eb,Q(b??0),Q(0),Q(r??0),Q(0))}function $n({timeScale:l,duration:n}){return _("mdhd",P(0,0),t(0),t(0),t(l),t(n),Q(21956),Q(0))}function hn({handlerType:l,handlerName:n}){return _("hdlr",P(0,0),t(0),pl(l),t(0),t(0),t(0),pl(n),V(1))}function Eb({}){return _("vmhd",P(0,1),V(8))}function Ub({}){return _("smhd",P(0,0),V(4))}function Jn(...l){return _("dref",P(0,0),t(l.length),...l)}function Qn(){return _("url ",V(4))}function _n(...l){return _("stsd",P(0,0),t(l.length),...l)}var gb=function(l){return({width:n,height:b},...r)=>_(l,V(6),Q(1),V(16),Q(n),Q(b),Q(72),Q(0),Q(72),Q(0),V(4),Q(1),[5],pl("jsmkv"),V(27),[24,255,255],...r)};function $b(l){return _("avcC",l)}function hb(l){return _("hvcC",l)}function Gb({sampleRate:l,sampleSize:n,channelCount:b},...r){return _("mp4a",V(6),Q(1),Q(0),Q(0),t(0),Q(b),Q(n),Q(0),Q(0),t(l),...r)}function Xb({codecPrivate:l}){return _("esds",P(0,0),t(58753152),[32+l.length],Q(1),[0],t(75530368),[18+l.length],[64],[21],[0,0,0],t(130071),t(130071),t(92307584),[l.length],l,t(109084800),[1],[2])}function Hn(...l){return _("stts",P(0,0),t(l.length),...l.map((n)=>A.concat(t(n.sampleCount),t(n.sampleDelta))))}function Wn(...l){return _("stsc",P(0,0),t(l.length),...l)}function Zn(...l){return _("stsz",P(0,0),t(0),t(l.length),...l.map(t))}function Kn(...l){return _("stco",P(0,0),t(l.length),...l.map(ub))}function Qb({trackId:l,defaultSampleDescriptionIndex:n}){return _("trex",P(0,0),t(l),t(n),t(0),t(0),t(0))}function Cn({sequenceNumber:l}){return _("mfhd",P(0,0),t(l))}function _b({trackId:l}){return _("tfhd",P(0,131072),t(l))}function Hb({baseMediaDecodeTime:l}){return _("tfdt",P(1,0),ub(l))}var yl=function(l){return l&3},Db=function(l){return yl(l.isLeading??0)<<26|yl(l.dependsOn??0)<<24|yl(l.isDependedOn??0)<<22|yl(l.hasRedundancy??0)<<20|yl(l.samplePaddingValue??0)<<17|yl(l.isNonSyncSample??0)<<16|(l.degradationPriority??0)&65535};function Wb({dataOffset:l,samples:n}){let b=0;const r=n.some((c)=>c.compositionTimeOffset!==void 0);if(l!==void 0)b|=1;if(b|=256,b|=512,b|=1024,r)b|=2048;return _("trun",P(1,b),t(n.length),l!==void 0?t(l):[],...n.map((c)=>A.concat(t(c.duration),t(c.size),t(Db(c.sampleFlags??{})),r?Ob(c.compositionTimeOffset??0):[])))}var pb=new ArrayBuffer(8),Yl=new DataView(pb),_l=new Uint8Array(pb),eb=new Uint8Array([0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0]);class A{chunks=[];privateLength=0;get byteLength(){return this.privateLength}get length(){return this.privateLength}append(...l){for(let n of l){const b=A.toParts(n);for(let r of b)this.chunks.push(r),this.privateLength+=r.length}}prepend(l){const n=A.toParts(l);for(let b of n)this.chunks.unshift(b),this.privateLength+=b.length}build(){let l=new Uint8Array(this.privateLength),n=0;for(let b of this.chunks)l.set(b,n),n+=b.length;return l}valueOf(){return this.build()}static concat(...l){let n=new A;for(let b of l)n.append(b);return n}static toParts(l){if(l instanceof A)return l.chunks;else if(l instanceof Uint8Array)return[l];else if(Array.isArray(l))return[new Uint8Array(l)];else throw new Error("Invalid part")}}var tb=O("moov"),Un=O("trak"),wn=O("mdia"),Gn=O("minf"),Xn=O("dinf"),Yn=O("stbl"),wb=gb("avc1"),ib=gb("hev1"),Jb=O("mvex"),qn=O("moof"),Yb=O("traf"),Zb=O("mdat");var Lb=function(l){return l=(l&1431655765)<<1|(l&2863311530)>>>1,l=(l&858993459)<<2|(l&3435973836)>>>2,l=(l&252645135)<<4|(l&4042322160)>>>4,l=(l&16711935)<<8|(l&4278255360)>>>8,l=(l&65535)<<16|(l&4294901760)>>>16,l>>>0},Kb=function(l){return Array.from(new Uint8Array(l)).map((n)=>n.toString(16).padStart(2,"0")).join("").toUpperCase()},fb=function(l){const n=new DataView(l),b=["","A","B","C"][n.getUint8(1)>>6&3],r=["L","H"][n.getUint8(1)>>5&1],c=n.getUint8(1)&31,y=Lb(n.getUint32(2)),e=n.getUint8(12),p=Kb(l.slice(6,12)).replace(/(00)*$/,"");return`hvc1.${b}${c}.${y}.${r}${e}.${p}`};async function*xb(l){let n;for await(let b of l){if(n!==void 0)yield[n,b];n=b}if(n!==void 0)yield[n,void 0]}function zb(){const l=new Map,n=new Map,b=async()=>{const r=document.querySelectorAll("video.mkv-player"),c=[];for(let y of r){const e=y.querySelectorAll("source");let p;for(let i of e)if(i.type==="video/x-matroska"||i.type===""&&i.src.endsWith(".mkv")){p=i.src;break}if(p===void 0)continue;if(l.get(y)===p)continue;n.get(y)?.destroy(),l.set(y,p),c.push([y,p])}for(let[y,e]of c){const p=await cl.fromUrl(e),o=new Nn(p,y);n.set(y,o)}};b(),setInterval(b,1000)}var db=["V_MPEG4/ISO/AVC","V_MPEGH/ISO/HEVC"],ab=["A_AAC"];class Pn{l;initPromise;initSegment;duration;mkvDuration;mkvSegment;mimeType;seeks;mkvTracks=new Map;constructor(l){this.source=l}async getInitSegment(){return await this.init(),this.initSegment}async getMimeType(){return await this.init(),this.mimeType}async getDuration(){return await this.init(),this.duration}async readCluster(l){const n=[];for await(let r of l.simpleBlocks)n.push(r);const b=new Map;for(let r of n){const c=await r.trackNumber;let y=b.get(c);if(y===void 0)y=[],b.set(c,y);y.push(r)}return b}async*streamFrom(l){await this.init();const n=this.mkvSegment,b=this.mkvDuration,r=this.seeks;let c=r.findIndex((o)=>o.time>=l)??r.length;c=Math.max(0,c-1);const y=r[c],e=n.seekClusters(y.clusterPosition);let p=c;for await(let[o,i]of xb(e)){p++;const $=await o.timestamp,m=await i?.timestamp??b,U=Math.max(0,m-$),C=await this.readCluster(o),g=new Map;for(let[Y,q]of C){const j=await q[0].timestamp;g.set(Y,j)}const H=i===void 0?void 0:await this.readCluster(i),w=new Map;if(H!==void 0)for(let[Y,q]of H){const j=await q[0].timestamp;w.set(Y,j)}const h=Array.from(this.mkvTracks.keys()),u=[];for(let Y of h){const q=this.mkvTracks.get(Y),j=q.mp4TrackId,B=C.get(Y)??[],D=[],Rn=[],El=[];for(let Z=0;Z<B.length;Z++){const Ul=await B[Z].timestamp;El.push(Ul)}const Pb=U+(w.get(Y)??0);El.push(Pb);let L=El.slice();for(let Z=L.length-1;Z>=1;Z--)L[Z-1]=Math.min(L[Z-1],L[Z]);const Mn=[];for(let Z=0;Z<B.length;Z++)Mn.push(L[Z+1]-L[Z]);for(let Z=0;Z<B.length;Z++){const Hl=B[Z],Ul=El[Z],Vn=L[Z],Wl=Mn[Z];if(Wl<0)throw console.log({pts:Ul,dts:Vn,duration:Wl}),new Error("Invalid duration");const Mb=await Hl.keyframe;let gl=await Hl.data;if(q.contentEncodings!==void 0)gl=await q.contentEncodings.decode(gl);Rn.push(new Uint8Array(gl)),D.push({duration:Wl,size:gl.byteLength,compositionTimeOffset:Ul-Vn,sampleFlags:{dependsOn:Mb||Z===0?2:1}})}const Nb=(Z)=>Yb(_b({trackId:j}),Hb({baseMediaDecodeTime:$+(g.get(Y)??0)}),Wb({dataOffset:Z,samples:D})),Rb=A.concat(...Rn);u.push({trackNumber:Y,traf:Nb,data:Rb})}const G=qn(Cn({sequenceNumber:p}),...u.map(({traf:Y})=>Y(0))).byteLength,X=u.reduce((Y,{data:q})=>[...Y,Y[Y.length-1]+q.byteLength],[G+8]),W=qn(Cn({sequenceNumber:p}),...u.map(({traf:Y},q)=>Y(X[q]))),N=Zb(...u.map(({data:Y})=>Y));yield A.concat(W,N).valueOf().buffer}}init(){if(this.initPromise===void 0)this.initPromise=this.initImpl();return this.initPromise}async initImpl(){const l=new f(this.source),b=await new Xl(l).one(x);this.mkvSegment=b;const r=await b.getCues(!0);if(r===void 0)throw new Error("Cues not found");const c=await b.info,y=await b.tracks;if(y===void 0)throw new Error("Tracks not found");const e=await c.timestampScale,p=await c.duration,o=p*(e/1e9);this.mkvDuration=p,this.duration=o;let i=!1,$=!1;const m=[];for await(let u of y.tracks){const G=await u.trackType,X=await u.codecID;switch(G){case"video":{if(i)continue;const W=await u.video;if(W===void 0)throw new Error("Video not found");if(!db.includes(X)){console.warn(`Unsupported video codec: ${X}, ignored`);continue}const N=await u.trackNumber;if(await u.defaultDuration===void 0)throw new Error("DefaultDuration not found");const q=await W.pixelWidth,j=await W.pixelHeight,B=await u.maybeOne(ll);if(B===void 0)throw new Error("CodecPrivate not found");const D=await B.element.data.arrayBuffer();m.push({type:"video",mkvTrackNumber:N,mp4TrackId:m.length+1,mimeCodec:X==="V_MPEGH/ISO/HEVC"?fb(D):`avc1.${Kb(D.slice(1,4))}`,trak:Un(gn({trackId:N,width:q,height:j}),wn($n({timeScale:1e9/e,duration:p}),hn({handlerType:"vide",handlerName:"VideoHandler"}),Gn(Eb({}),Xn(Jn(Qn())),Yn(_n(X==="V_MPEGH/ISO/HEVC"?ib({width:q,height:j},hb(new Uint8Array(D))):wb({width:q,height:j},$b(new Uint8Array(D)))),Hn(),Wn(),Zn(),Kn())))),contentEncodings:await u.maybeOne(s)}),i=!0;break}case"audio":{if($)continue;const W=await u.audio;if(W===void 0)throw new Error("Audio not found");if(!ab.includes(X)){console.warn(`Unsupported audio codec: ${X}, ignored`);continue}const N=await u.trackNumber,Y=await W.channels,q=await W.samplingFrequency,j=await W.bitDepth??16,B=await u.maybeOne(ll);if(B===void 0)throw new Error("CodecPrivate not found");const D=await B.element.data.arrayBuffer();m.push({type:"audio",mkvTrackNumber:N,mp4TrackId:m.length+1,mimeCodec:"mp4a.40.2",trak:Un(gn({trackId:N}),wn($n({timeScale:1e9/e,duration:p}),hn({handlerType:"soun",handlerName:"SoundHandler"}),Gn(Ub({}),Xn(Jn(Qn())),Yn(_n(Gb({channelCount:Y,sampleRate:q,sampleSize:j},Xb({codecPrivate:new Uint8Array(D)}))),Hn(),Wn(),Zn(),Kn())))),contentEncodings:await u.maybeOne(s)}),$=!0;break}}}const U=m.find((u)=>u.type==="video"),C=m.find((u)=>u.type==="audio");if(U===void 0)throw new Error("Video track not found");for(let u of m)this.mkvTracks.set(u.mkvTrackNumber,u);let g=[];if(U!==void 0)g.push(U.mimeCodec);if(C!==void 0)g.push(C.mimeCodec);const H=`video/mp4; codecs="${g.join(", ")}"`;this.mimeType=H;const w=[];for await(let u of r.cuePoints){const X=await u.cueTime*(e/1e9),W=await u.cueTrackPositions;for await(let N of W)if(await N.cueTrack===U.mkvTrackNumber){const Y=await N.cueClusterPosition;w.push({time:X,clusterPosition:Y});break}}this.seeks=w;const h=A.concat(ob({majorBrand:"isom",minorVersion:0,compatibleBrands:["isom","iso2","mp41","mp42",...U.mimeCodec.startsWith("avc1")?["avc1"]:[]]}),tb(mb({timeScale:1e9/e,duration:p,nextTrackId:m.length+1}),...m.map((u)=>u.trak),Jb(...m.map((u)=>Qb({trackId:u.mp4TrackId,defaultSampleDescriptionIndex:1})))));this.initSegment=h.valueOf().buffer}}class qb{resolve;reject;constructor(){}async wait(){return new Promise((l,n)=>{this.resolve=l,this.reject=n})}signal(l){if(this.resolve===void 0)throw new Error("Signal not waiting");this.resolve(l)}signalError(l){if(this.reject===void 0)throw new Error("Signal not waiting");this.reject(l)}}class Nn{l;n;b;destroyed=!1;destroySignal=new qb;constructor(l,n,b){this.source=l;this.video=n;this.options=b;this.init()}async destroy(){if(this.destroyed)return;this.destroyed=!0,await this.destroySignal.wait()}async init(){const l=new Pn(this.source),n=await l.getMimeType();console.log("MIME type:",n);const b=await l.getDuration(),r=await l.getInitSegment(),c=this.video,y=new MediaSource;c.src=URL.createObjectURL(y),await new Promise((m)=>{const U=()=>{y.removeEventListener("sourceopen",U),m()};y.addEventListener("sourceopen",U)}),y.duration=b;const e=y.addSourceBuffer(n),p=()=>new Promise((m)=>{if(e.updating){const U=()=>{e.removeEventListener("updateend",U),m()};e.addEventListener("updateend",U)}else m()});e.mode="segments",e.appendBuffer(r),await p();const o=this.options?.maxBufferSeconds??60;let i=!0;const $=()=>{i=!0};c.addEventListener("seeking",$);while(!0){i=!1;const m=c.currentTime,U=l.streamFrom(m);for await(let C of U){if(i||this.destroyed)break;const g=[];for(let h=0;h<c.buffered.length;h++){const u=c.buffered.start(h),G=c.buffered.end(h);if(g.length>0){const X=g[g.length-1];if(u-X[1]<0.5){X[1]=G;continue}}g.push([u,G])}const H=c.currentTime,w=g.find(([h,u])=>h<=H&&H<=u);while(w!==void 0&&c.currentTime+o<w[1]){if(i||this.destroyed)break;await new Promise((h)=>{window.setTimeout(h,100)})}if(i||this.destroyed)break;if(e.appendBuffer(C),await p(),g.length>0){const h=c.currentTime,u=g[0][0],G=g[g.length-1][1],X=Math.max(u,h-o*2),W=Math.min(G,h+o*2);if(u<X)e.remove(0,X),await p();if(G>W)e.remove(W,G),await p()}}if(this.destroyed)break;while(!i)await new Promise((C)=>{window.setTimeout(C,100)})}c.removeEventListener("seeking",$),y.endOfStream(),y.removeSourceBuffer(e),c.src="",URL.revokeObjectURL(c.src),this.destroySignal.signal()}}export{jn as vint,Cb as player,lb as mkv,T as ebml,yb as bloblike};
